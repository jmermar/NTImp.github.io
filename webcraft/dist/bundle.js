var game;(()=>{"use strict";var t={d:(e,s)=>{for(var r in s)t.o(s,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:s[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{main:()=>T});var s="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;var r=Math.PI/180;function i(t){return t*r}function n(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var o;o=new s(3),s!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0);const a={world:null,input:null,rm:null,gl:null,selector:["dirt","stone","glass","sand","wood","leaf","bricks","planks","water"],canvas:null};class h{static collision(t,e){e instanceof Set||(e=new Set);for(var s=Math.floor(t.position[0]),r=Math.floor(t.position[1]),i=Math.floor(t.position[2]),n=Math.floor(t.position[0]+t.size[0]),o=Math.floor(t.position[1]+t.size[1]),h=Math.floor(t.position[2]+t.size[2]),l=!1,d=null,c=null,u=null,g=null,m=null,p=null,f=new Set,v=!1,w=s;w<=n;w++)for(var k=r;k<=o;k++)for(var x=i;x<=h;x++)1==a.world.getBlock(w,k,x).nocoll||e.has([w,k,x].join(","))?"water"==a.world.getBlock(w,k,x).name&&(v=!0):(l=!0,d=this.max(w+1,d),g=this.min(w,g),c=this.max(k+1,c),m=this.min(k,m),u=this.max(x+1,u),p=this.min(x,p),f.add([w,k,x].join(",")));return{collision:l,max:[d,c,u],min:[g,m,p],blocks:f,water:v}}static max(t,e){return null==t?e:null==e||t>e?t:e}static min(t,e){return null==t?e:null==e||t<e?t:e}}class l{constructor(t,e,s){this.world=a.world,this.position=t.slice(0),this.dir=new Array(3),this.max=s,function(t,e){var s=e[0],r=e[1],i=e[2],n=s*s+r*r+i*i;n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(this.dir,e)}getBlock(t){var e,s,r,i=null,o=this.position.slice(),h=new Array(3),l=new Array(3);!function(t,e,s){t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s}(h,this.dir,t);for(var d=0;d<this.max&&(n(l,o,h),e=Math.floor(l[0]),s=Math.floor(l[1]),r=Math.floor(l[2]),(i=a.world.getBlock(e,s,r)).nocoll);d+=t)o=l.slice(0);var c=Math.floor(o[0])-e,u=Math.floor(o[1])-s,g=Math.floor(o[2])-r;return i.nocoll?null:{block:i,position:[e,s,r],normal:[c,u,g]}}}class d{constructor(t,e,s){this.world=t,this.pos=e.slice(0),this.rot=s.slice(0),this.speed=5,this.rotSpeed=15,this.width=.8,this.height=1.9,this.vspeed=0,this.movingCamera=!1,this.buildBlock="grass",this.pressing=!1,this.state=0,this.setGravityAndJump(1.2,.5)}raycast(){var t=a.world.render.screenToWorld(a.input.mouseX,a.input.mouseY);!function(t,e,s){t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2]}(t,t,this.eyePos);var e=new l(this.eyePos,t,20);this.rBlock=e.getBlock(.05)}setGravityAndJump(t,e){this.jumpSpeed=4*t/e,this.gravity=2*this.jumpSpeed/e}update(t){this.raycast(),a.input.keypress("noclip")&&(this.state=1),a.input.keypress("physics")&&(this.state=0),0!=a.input.mousePressed&&(this.pressing=!0,(Math.abs(a.input.deltaX)-4>0||Math.abs(a.input.deltaY)-4>0)&&(this.movingCamera=!0)),0==a.input.mousePressed&&(this.movingCamera||null!=this.rBlock&&this.pressing&&a.world.setBlock(this.rBlock.position[0],this.rBlock.position[1],this.rBlock.position[2],"air",!0),this.pressing=!1,this.movingCamera=!1),this.movingCamera&&(this.rot[1]+=a.input.deltaX*t*this.rotSpeed,this.rot[0]+=a.input.deltaY*t*this.rotSpeed,this.rot[0]<-75&&(this.rot[0]=-75),this.rot[0]>75&&(this.rot[0]=75)),1==a.input.mouseRightPressed&&null!=this.rBlock&&a.world.setBlock(this.rBlock.position[0]+this.rBlock.normal[0],this.rBlock.position[1]+this.rBlock.normal[1],this.rBlock.position[2]+this.rBlock.normal[2],this.buildBlock,!0),0==this.state?this.updatePhysics(t):this.updateNoclip(t)}updateNoclip(t){var e=this.rotation[1],s=0,r=0,n=0;a.input.keypress("w")&&(n-=Math.cos(i(e))*t*this.speed,s+=Math.sin(i(e))*t*this.speed),a.input.keypress("s")&&(n+=Math.cos(i(e))*t*this.speed,s-=Math.sin(i(e))*t*this.speed),a.input.keypress("d")&&(n+=Math.sin(i(e))*t*this.speed,s+=Math.cos(i(e))*t*this.speed),a.input.keypress("a")&&(n-=Math.sin(i(e))*t*this.speed,s-=Math.cos(i(e))*t*this.speed),a.input.keypress("jump")&&(r+=this.speed*t),a.input.keypress("shift")&&(r-=this.speed*t),this.pos[0]+=s,this.pos[1]+=r,this.pos[2]+=n}updatePhysics(t){this.checkWater();var e=this.rotation[1],s=(e=this.rotation[1],0),r=0,n=0;a.input.keypress("w")&&(n-=Math.cos(i(e))*t*this.speed,s+=Math.sin(i(e))*t*this.speed),a.input.keypress("s")&&(n+=Math.cos(i(e))*t*this.speed,s-=Math.sin(i(e))*t*this.speed),a.input.keypress("d")&&(n+=Math.sin(i(e))*t*this.speed,s+=Math.cos(i(e))*t*this.speed),a.input.keypress("a")&&(n-=Math.sin(i(e))*t*this.speed,s-=Math.cos(i(e))*t*this.speed);var o=1;this.onWater?(a.input.keypress("jump")&&this.canSwim&&(this.vspeed=this.jumpSpeed/3),o=.25):a.input.keypress("jump")&&this.ground&&(this.vspeed=this.jumpSpeed),this.vspeed-=this.gravity*o*t,r+=this.vspeed*t,this.movePlayer(s,r,n)}checkWater(){var t=h.collision(this.collbox);this.onWater=t.water;var e=this.collbox;e.size[1]/=6,e.position[1]+=e.size[1],this.canSwim=h.collision(e).water}movePlayer(t,e,s){var r,i=h.collision(this.collbox).blocks;0!=e&&(this.pos[1]+=e,(r=h.collision(this.collbox,i)).collision?(e<0&&(this.ground=!0,this.vspeed=0),this.pos[1]=e>0?r.min[1]-.01-this.height:r.max[1]):this.ground=!1),0!=t&&(this.pos[0]+=t,(r=h.collision(this.collbox,this.world,i)).collision&&(this.pos[0]=t>0?r.min[0]-.01-this.width/2:r.max[0]+.01+this.width/2)),0!=s&&(this.pos[2]+=s,(r=h.collision(this.collbox,this.world,i)).collision&&(this.pos[2]=s>0?r.min[2]-.01-this.width/2:r.max[2]+.01+this.width/2))}get position(){return this.pos.slice()}get rotation(){return this.rot.slice()}get collbox(){return{position:[this.pos[0]-this.width/2,this.pos[1],this.pos[2]-this.width/2],size:[this.width,this.height,this.width]}}get eyePos(){return[this.pos[0],this.pos[1]+1.8,this.pos[2]]}}const c=[{name:"air",nocoll:!0,air:!0,transparent:!0},{name:"nopass",air:!0,transparent:!0},{name:"dirt",top:[0,0],bottom:[0,0],sides:[0,0],refresh:function(t,e,s,r){var i=a.world.getBlock(e,s+1,r);if(i.transparent&&"water"!=i.name)for(var n=s-1;n<=s+1;n++){var o=a.world.getBlock(e-1,n,r).name,h=a.world.getBlock(e+1,n,r).name,l=a.world.getBlock(e,n,r+1).name,d=a.world.getBlock(e,n,r-1).name;if("grass"==o||"grass"==h||"grass"==l||"grass"==d){a.world.setBlock(e,s,r,"grass",!0);break}}}},{name:"water",nocoll:!0,transparent:!0,top:[3,0],bottom:[3,0],sides:[3,0],refresh:function(t,e,s,r){a.world.getBlock(e-1,s,r).air&&a.world.setBlock(e-1,s,r,"water",!0),a.world.getBlock(e+1,s,r).air&&a.world.setBlock(e+1,s,r,"water",!0),a.world.getBlock(e,s-1,r).air&&a.world.setBlock(e,s-1,r,"water",!0),a.world.getBlock(e,s,r-1).air&&a.world.setBlock(e,s,r-1,"water",!0),a.world.getBlock(e,s,r+1).air&&a.world.setBlock(e,s,r+1,"water",!0)}},{name:"grass",top:[0,3],bottom:[0,0],sides:[1,3],refresh:function(t,e,s,r){var i=a.world.getBlock(e,s+1,r);i.transparent&&"water"!=i.name||a.world.setBlock(e,s,r,"dirt",!0)}},{name:"snowgrass",top:[2,3],bottom:[0,0],sides:[3,3]},{name:"snow",top:[2,3],bottom:[2,3],sides:[2,3]},{name:"stone",top:[1,0],bottom:[1,0],sides:[1,0]},{name:"sand",top:[2,0],bottom:[2,0],sides:[2,0],refresh:function(t,e,s,r){a.world.getBlock(e,s-1,r).nocoll&&(a.world.setBlock(e,s,r,"air",!0),a.world.setBlock(e,s-1,r,"sand",!0))}},{name:"glass",top:[0,2],bottom:[0,2],sides:[0,2],transparent:!0},{name:"wood",top:[1,1],bottom:[1,1],sides:[0,1]},{name:"leaf",top:[2,1],bottom:[2,1],sides:[2,1]},{name:"bricks",top:[1,2],bottom:[1,2],sides:[1,2]},{name:"planks",top:[3,2],bottom:[3,2],sides:[3,2]}];class u{constructor(t,e,s){this.generated=!1,this.render=s,this.size=t,this.height=e,this.renderDistance=8,this.updateTicks=4,this.updateWait=0,this.cl=16,this.blockMaps=new Map;var r=this;c.forEach((function(t,e){t.id=e,r.blockMaps.set(t.name,t)})),this.map=new Int16Array(this.numChunks*this.chunkVolume),this.chunks=new Map,this.refresh=new Array,this.nextRefresh=new Array,this.createBorders()}get numChunks(){return this.size*this.size*this.height}get chunkVolume(){return this.cl*this.cl*this.cl}get worldLength(){return this.cl*this.size}get worldHeight(){return this.cl*this.height}autoLoadChunks(){var t=this;this.interval=setInterval((function(){t.loader()}),100),this.fchunks=setInterval((function(){t.freeChunks()}),100)}stopAutoLoad(){clearInterval(this.interval),clearInterval(this.fchunks)}freeChunks(){const t=this;var e=[];this.chunks.forEach((function(s,r){var i=Math.floor(Math.abs(s.position[0]*t.cl+t.cl/2-t.player.eyePos[0])/t.cl),n=Math.floor(Math.abs(s.position[2]*t.cl+t.cl/2-t.player.eyePos[2])/t.cl);(i>t.renderDistance||n>t.renderDistance)&&e.push(r)})),e.forEach((function(e){t.render.freeChunk(e),t.chunks.delete(e)}))}loader(){var t=0,e=0,s=0,r=1,i=Math.floor(Math.max(0,this.player.eyePos[0]/this.cl-r)),n=Math.floor(Math.max(0,this.player.eyePos[2]/this.cl-r)),o=Math.floor(Math.min(this.size-1,this.player.eyePos[0]/this.cl+r)),a=Math.floor(Math.min(this.size-1,this.player.eyePos[2]/this.cl+r));for(t=i,e=0,s=n;null!=this.chunks.get(this.chunkHash(t,e,s));)if(++e>=this.height&&(e=0,++t>o&&(t=i,++s>a))){if(++r>this.renderDistance)return;i=Math.floor(Math.max(0,this.player.eyePos[0]/this.cl-r)),n=Math.floor(Math.max(0,this.player.eyePos[2]/this.cl-r)),o=Math.floor(Math.min(this.size-1,this.player.eyePos[0]/this.cl+r)),a=Math.floor(Math.min(this.size-1,this.player.eyePos[2]/this.cl+r)),t=i,s=n}for(e=0;e<this.height;e++)null==this.chunks.get(this.chunkHash(t,e,s))&&this.chunks.set(this.chunkHash(t,e,s),{position:[t,e,s],dirty:!0})}createBorders(){var t={vertex:new Array(this.worldHeight*this.worldLength*24),coords:new Array(this.worldHeight*this.worldLength*8),indices:new Array(this.worldHeight*this.worldLength*6)};const e=[0,1,0,1,1,0,1,0,0,0,0,0],s=this.blockMaps.get("glass").sides,r=[s[0]/16,s[1]/16,(s[0]+1)/16,(s[1]+1)/16];for(var i=0;i<this.worldLength;i++)for(var n=0;n<this.worldHeight;n++){const s=n*this.worldLength+i;for(var o=0;o<4;o++){const r=24*s+6*o;t.vertex[r+0]=i+e[0+3*o],t.vertex[r+1]=n+e[1+3*o],t.vertex[r+2]=0+e[2+3*o],t.vertex[r+3]=0,t.vertex[r+4]=0,t.vertex[r+5]=-1}t.indices[6*s+0]=4*s+2,t.indices[6*s+1]=4*s+1,t.indices[6*s+2]=4*s,t.indices[6*s+3]=4*s+3,t.indices[6*s+4]=4*s+2,t.indices[6*s+5]=4*s,t.coords[8*s+0]=r[0],t.coords[8*s+1]=r[1],t.coords[8*s+2]=r[2],t.coords[8*s+3]=r[1],t.coords[8*s+4]=r[2],t.coords[8*s+5]=r[3],t.coords[8*s+6]=r[0],t.coords[8*s+7]=r[3]}this.render.loadModel("wall","atlas",t),this.render.addInstance("wall",{position:[0,0,0],rotation:[0,0,0]}),this.render.addInstance("wall",{position:[this.worldLength,0,this.worldLength],rotation:[0,180,0]}),this.render.addInstance("wall",{position:[this.worldLength,0,0],rotation:[0,-90,0]}),this.render.addInstance("wall",{position:[0,0,this.worldLength],rotation:[0,90,0]})}placePlayer(){for(var t=[this.worldLength/2,this.worldHeight,this.worldLength/2],e=this.worldHeight;e>0;e--)if("air"!=this.getBlock(t[0],e-1,t[2]).name){t[1]=e+1;break}this.player=new d(this,t,[0,0,0])}generateTerrain(t,e){noise.seed(Math.random()),this.progress=0;var s=this,r=function(e,r,i){s.progress=0;var n=0,o=0,a=function(){t(r),e(n,o),s.progress+=1/(s.size*s.size),++n>=s.size&&(n=0,++o>=s.size)?i():requestAnimationFrame(a)};requestAnimationFrame(a)};r(s.generateChunkTerrain.bind(s),"Generating chunk terrain.",(function(){r(s.generateChunkCaves.bind(s),"Generating caves.",(function(){r(s.decorateChunk.bind(s),"Decorating chunks.",(function(){s.placePlayer(),e()}))}))}))}generateChunkTerrain(t,e){for(var s=t*this.cl;s<(t+1)*this.cl;s++)for(var r=e*this.cl;r<(e+1)*this.cl;r++)for(var i=(this.worldLength/2-s)/(this.worldLength/2),n=(this.worldLength/2-r)/(this.worldLength/2),o=Math.sqrt(i*i+n*n),a=Math.floor(53+6*noise.simplex2(s/50,r/50))-o*o*7,h=0;h<this.worldHeight;h++){var l;l=h<=a?"stone":h<=49?"water":"air",this.setBlock(s,h,r,l)}}generateChunkCaves(t,e){for(var s=t*this.cl;s<(t+1)*this.cl;s++)for(var r=e*this.cl;r<(e+1)*this.cl;r++)for(var i=0;i<this.worldHeight;i++){var n=(i/65+3*noise.simplex3(s/12,i/10,r/12)+10*noise.simplex3(s/80,i/20,r/80))/14,o=this.getBlock(s,i,r).name;n<-.5&&"stone"==o&&(o="air"),0==i&&(o="stone"),this.setBlock(s,i,r,o)}}decorateChunk(t,e){for(var s=t*this.cl;s<(t+1)*this.cl;s++)for(var r=e*this.cl;r<(e+1)*this.cl;r++)for(var i=-1,n=this.worldHeight-1;n>=0;n--){var o=this.getBlock(s,n,r).name,a=o,h=this.getBlock(s,n+1,r).name;-1==i&&"stone"==o&&("air"==h&&(a="grass",i=n),"water"==h&&(a="dirt",i=n)),"water"==h&&"air"==o?a="water":n>=i-4&&n<i&&(a="dirt"),this.setBlock(s,n,r,a)}}getBlock(t,e,s){return t<0||t>=this.worldLength||s<0||s>=this.worldLength||e<0||e>=this.worldHeight?this.blockMaps.get("nopass"):c[this.map[e*this.worldLength*this.worldLength+s*this.worldLength+t]]}updateChunk(t,e,s){if(!(t<0||t>=this.size||e<0||e>=this.height||s<0||s>=this.size)){var r=this.chunks.get(this.chunkHash(t,e,s));null!=r&&(r.dirty=!0)}}setBlock(t,e,s,r,i){if(!(t<0||t>=this.cl*this.size||s<0||s>=this.cl*this.size||e<0||e>=this.cl*this.height)){this.map[e*this.worldLength*this.worldLength+s*this.worldLength+t]=this.blockMaps.get(r).id;var n=Math.floor(t/this.cl),o=Math.floor(e/this.cl),a=Math.floor(s/this.cl);this.updateChunk(n,o,a),t%this.cl==0&&this.updateChunk(n-1,o,a),e%this.cl==0&&this.updateChunk(n,o-1,a),s%this.cl==0&&this.updateChunk(n,o,a-1),t%this.cl-1&&this.updateChunk(n+1,o,a),e%this.cl-1&&this.updateChunk(n,o+1,a),s%this.cl-1&&this.updateChunk(n,o,a+1),i&&(this.nextRefresh.push([t,e,s]),this.nextRefresh.push([t-1,e,s]),this.nextRefresh.push([t,e-1,s]),this.nextRefresh.push([t,e,s-1]),this.nextRefresh.push([t+1,e,s]),this.nextRefresh.push([t,e+1,s]),this.nextRefresh.push([t,e,s+1]))}}refreshBlock(t,e,s){var r=this.getBlock(t,e,s);null!=r.refresh&&r.refresh(this,t,e,s)}updateBlock(t,e,s){if("dirt"==this.getBlock(t,e,s).name)for(var r=e-1;r<=e+1;r++){var i=this.getBlock(t-1,r,s).name,n=this.getBlock(t+1,r,s).name,o=this.getBlock(t,r,s+1).name,a=this.getBlock(t,r,s-1).name,h=this.getBlock(t-1,r+1,s),l=this.getBlock(t+1,r+1,s),d=this.getBlock(t,r+1,s+1),c=this.getBlock(t,r+1,s-1);if("grass"==i&&h.transparent){this.setBlock(t,e,s,"grass",!0);break}if("grass"==n&&l.transparent){this.setBlock(t,e,s,"grass",!0);break}if("grass"==o&&d.transparent){this.setBlock(t,e,s,"grass",!0);break}if("grass"==a&&c.transparent){this.setBlock(t,e,s,"grass",!0);break}}}update(t){var e=this,s=!1;this.updateWait+=t,this.updateWait>=1/this.updateTicks&&(s=!1,this.updateWait=0);var r=this.nextRefresh;this.nextRefresh=[],e.refresh.length>0&&e.refresh.forEach((function(t){e.refreshBlock(t[0],t[1],t[2])})),this.refresh=r,this.chunks.forEach((function(t,r,i){if(s){var n=t.position[0]*e.cl+Math.floor(Math.random()*e.cl),o=t.position[1]*e.cl+Math.floor(Math.random()*e.cl),a=t.position[2]*e.cl+Math.floor(Math.random()*e.cl);e.updateBlock(n,o,a)}t.dirty&&(t.dirty=!1,e.render.generateChunkMesh(e,t.position))})),this.player.update(t),this.render.setCam(this.player.eyePos,this.player.rotation)}chunkHash(t,e,s){return e*this.size*this.size+s*this.size+t}}function g(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function m(t,e,s){var r,i,n,o,a,h,l,d,c,u,g,m,p=s[0],f=s[1],v=s[2];return e===t?(t[12]=e[0]*p+e[4]*f+e[8]*v+e[12],t[13]=e[1]*p+e[5]*f+e[9]*v+e[13],t[14]=e[2]*p+e[6]*f+e[10]*v+e[14],t[15]=e[3]*p+e[7]*f+e[11]*v+e[15]):(r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],g=e[10],m=e[11],t[0]=r,t[1]=i,t[2]=n,t[3]=o,t[4]=a,t[5]=h,t[6]=l,t[7]=d,t[8]=c,t[9]=u,t[10]=g,t[11]=m,t[12]=r*p+a*f+c*v+e[12],t[13]=i*p+h*f+u*v+e[13],t[14]=n*p+l*f+g*v+e[14],t[15]=o*p+d*f+m*v+e[15]),t}function p(t,e,s,r){var i,n,o,a,h,l,d,c,u,g,m,p,f,v,w,k,x,y,M,b,B,E,T,A,C=r[0],_=r[1],R=r[2],P=Math.hypot(C,_,R);return P<1e-6?null:(C*=P=1/P,_*=P,R*=P,i=Math.sin(s),o=1-(n=Math.cos(s)),a=e[0],h=e[1],l=e[2],d=e[3],c=e[4],u=e[5],g=e[6],m=e[7],p=e[8],f=e[9],v=e[10],w=e[11],k=C*C*o+n,x=_*C*o+R*i,y=R*C*o-_*i,M=C*_*o-R*i,b=_*_*o+n,B=R*_*o+C*i,E=C*R*o+_*i,T=_*R*o-C*i,A=R*R*o+n,t[0]=a*k+c*x+p*y,t[1]=h*k+u*x+f*y,t[2]=l*k+g*x+v*y,t[3]=d*k+m*x+w*y,t[4]=a*M+c*b+p*B,t[5]=h*M+u*b+f*B,t[6]=l*M+g*b+v*B,t[7]=d*M+m*b+w*B,t[8]=a*E+c*T+p*A,t[9]=h*E+u*T+f*A,t[10]=l*E+g*T+v*A,t[11]=d*E+m*T+w*A,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}!function(){var t=new s(4);s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();class f{constructor(){this.chunkMeshes=new Map,this.models=new Map,this.altas=a.rm.getTexture("atlas"),this.shader=a.rm.createShader("normal","#version 300 es\r\nprecision mediump float;\r\n\r\nlayout(location = 0) in vec3 vertPosition;\r\nlayout(location = 1) in vec3 normalPosition;\r\nlayout(location = 2) in vec2 vertTexCoord;\r\nout vec2 fragTexCoord;\r\nout float o_light;\r\nuniform mat4 modelMatrix;\r\nuniform mat4 viewMatrix;\r\nuniform mat4 projMatrix;\r\n\r\nvoid main()\r\n{\r\n  vec3 unitNormal = (modelMatrix * vec4(normalPosition, 0)).xyz;\r\n  o_light = min(1.0, max(0.5, dot(vec3(1, 2, 0.5), unitNormal)));\r\n  fragTexCoord = vertTexCoord;\r\n  gl_Position = projMatrix * viewMatrix * modelMatrix * vec4(vertPosition, 1.0);\r\n}","#version 300 es\r\nprecision mediump float;\r\n\r\nin vec2 fragTexCoord;\r\nin float o_light;\r\nuniform sampler2D sampler;\r\nout vec4 fragColor;\r\n\r\nvoid main()\r\n{\r\n  fragColor = texture(sampler, fragTexCoord);\r\n  float a = fragColor.a;\r\n  fragColor = fragColor * o_light;\r\n  fragColor.a = a;\r\n}"),this.mUniform=this.shader.getUniform("modelMatrix"),this.vUniform=this.shader.getUniform("viewMatrix"),this.pUniform=this.shader.getUniform("projMatrix"),a.gl.enable(a.gl.DEPTH_TEST),a.gl.enable(a.gl.CULL_FACE),a.gl.enable(a.gl.SAMPLE_ALPHA_TO_COVERAGE),a.gl.sampleCoverage(.9,!1),a.gl.frontFace(a.gl.CW),a.gl.cullFace(a.gl.FRONT),this.pMatrix=new Float32Array(16),this.mvMatrix=new Float32Array(16),this.vMatrix=new Float32Array(16),this.sToWorld=new Float32Array(16),this.resizeCanvas(800,600),this.setCam([0,0,0],[0,0,0])}get opengl(){return a.gl}loadModel(t,e,s){var r=this.models.get(t);null!=r&&(r.mesh.free(),r.tex.free()),r={mesh:a.rm.createMesh(t+"_m",s),tex:a.rm.getTexture(e),instances:new Set},this.models.set(t,r)}freeModel(t){var e=this.models.get(t);null!=e&&(a.rm.freeMesh(t+"_m"),this.models.delete(e))}addInstance(t,e){var s=this.models.get(t).instances,r=new Float32Array(16);g(r),m(r,r,e.position),p(r,r,i(e.rotation[0]),[1,0,0]),p(r,r,i(e.rotation[1]),[0,1,0]),p(r,r,i(e.rotation[2]),[0,0,1]),e.matrix=r,s.add(e)}clearColor(t,e,s){a.gl.clearColor(t,e,s,1)}freeChunk(t){var e=this.chunkMeshes.get(t);null!=e&&(null!=e.block_mesh&&a.rm.freeMesh(t+"_bm"),null!=e.water_mesh&&a.rm.freeMesh(t+"_wm")),this.chunkMeshes.delete(t)}generateChunkMesh(t,e){const s=a.world.chunkHash(e[0],e[1],e[2]);this.chunkMeshes.get(s),this.freeChunk(s);let r={vertex:[],indices:[],coords:[]},i={vertex:[],indices:[],coords:[]};for(var n=0;n<a.world.cl;n++)for(var o=0;o<a.world.cl;o++)for(var h=0;h<a.world.cl;h++){var l=n+e[0]*a.world.cl,d=o+e[1]*a.world.cl,c=h+e[2]*a.world.cl,u=a.world.getBlock(l,d,c),p=function(t,e,s,r){for(var i=Math.floor(r.vertex.length/6),a=0;a<4;a++)r.vertex.push(n+t[0+3*a]),r.vertex.push(o+t[1+3*a]),r.vertex.push(h+t[2+3*a]),r.vertex.push(s[0]),r.vertex.push(s[1]),r.vertex.push(s[2]);r.indices.push(i),r.indices.push(i+1),r.indices.push(i+2),r.indices.push(i),r.indices.push(i+2),r.indices.push(i+3);var l=[e[0]/16,e[1]/16,(e[0]+1)/16,(e[1]+1)/16];r.coords.push(l[0]),r.coords.push(l[1]),r.coords.push(l[2]),r.coords.push(l[1]),r.coords.push(l[2]),r.coords.push(l[3]),r.coords.push(l[0]),r.coords.push(l[3])};if(!u.air){var f=r;"water"==u.name&&(f=i);var v=null;(v=u.transparent?function(t){return t.transparent?t.name!=u.name:t.air}:function(t){return 1==t.transparent})(a.world.getBlock(l-1,d,c))&&p([0,1,1,0,1,0,0,0,0,0,0,1],u.sides,[-1,0,0],f),v(a.world.getBlock(l+1,d,c))&&p([1,1,0,1,1,1,1,0,1,1,0,0],u.sides,[1,0,0],f),v(a.world.getBlock(l,d,c-1))&&p([0,1,0,1,1,0,1,0,0,0,0,0],u.sides,[0,0,-1],f),v(a.world.getBlock(l,d,c+1))&&p([1,1,1,0,1,1,0,0,1,1,0,1],u.sides,[0,0,1],f),v(a.world.getBlock(l,d+1,c))&&p([0,1,1,1,1,1,1,1,0,0,1,0],u.top,[0,1,0],f),v(a.world.getBlock(l,d-1,c))&&p([0,0,0,1,0,0,1,0,1,0,0,1],u.bottom,[0,-1,0],f)}}var w=null,k=null;if(r.indices.length>0&&(w=a.rm.createMesh(s+"_bm",r)),i.indices.length>0&&(k=a.rm.createMesh(s+"_wm",i)),null!=w||null!=k){var x=new Float32Array(16);g(x),m(x,x,[e[0]*a.world.cl,e[1]*a.world.cl,e[2]*a.world.cl]),this.chunkMeshes.set(s,{model:x,block_mesh:w,water_mesh:k})}}resizeCanvas(t,e){(function(t,e,s,r,i){var n,o=1/Math.tan(e/2);t[0]=o/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(n=1/(r-i),t[10]=(i+r)*n,t[14]=2*i*r*n):(t[10]=-1,t[14]=-2*r)})(this.pMatrix,i(90),t/e,.1,1e3),a.canvas.width=t,a.canvas.height=e,a.gl.viewport(0,0,t,e)}setCam(t,e){var s=[-t[0],-t[1],-t[2]];g(this.vMatrix),p(this.vMatrix,this.vMatrix,i(e[0]),[1,0,0]),p(this.vMatrix,this.vMatrix,i(e[1]),[0,1,0]),p(this.vMatrix,this.vMatrix,i(e[2]),[0,0,1]),m(this.vMatrix,this.vMatrix,s);var r=new Float32Array(16);(function(t,e,s){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],g=e[10],m=e[11],p=e[12],f=e[13],v=e[14],w=e[15],k=s[0],x=s[1],y=s[2],M=s[3];t[0]=k*r+x*a+y*c+M*p,t[1]=k*i+x*h+y*u+M*f,t[2]=k*n+x*l+y*g+M*v,t[3]=k*o+x*d+y*m+M*w,k=s[4],x=s[5],y=s[6],M=s[7],t[4]=k*r+x*a+y*c+M*p,t[5]=k*i+x*h+y*u+M*f,t[6]=k*n+x*l+y*g+M*v,t[7]=k*o+x*d+y*m+M*w,k=s[8],x=s[9],y=s[10],M=s[11],t[8]=k*r+x*a+y*c+M*p,t[9]=k*i+x*h+y*u+M*f,t[10]=k*n+x*l+y*g+M*v,t[11]=k*o+x*d+y*m+M*w,k=s[12],x=s[13],y=s[14],M=s[15],t[12]=k*r+x*a+y*c+M*p,t[13]=k*i+x*h+y*u+M*f,t[14]=k*n+x*l+y*g+M*v,t[15]=k*o+x*d+y*m+M*w})(r,this.pMatrix,this.vMatrix),function(t,e){var s=e[0],r=e[1],i=e[2],n=e[3],o=e[4],a=e[5],h=e[6],l=e[7],d=e[8],c=e[9],u=e[10],g=e[11],m=e[12],p=e[13],f=e[14],v=e[15],w=s*a-r*o,k=s*h-i*o,x=s*l-n*o,y=r*h-i*a,M=r*l-n*a,b=i*l-n*h,B=d*p-c*m,E=d*f-u*m,T=d*v-g*m,A=c*f-u*p,C=c*v-g*p,_=u*v-g*f,R=w*_-k*C+x*A+y*T-M*E+b*B;R&&(R=1/R,t[0]=(a*_-h*C+l*A)*R,t[1]=(i*C-r*_-n*A)*R,t[2]=(p*b-f*M+v*y)*R,t[3]=(u*M-c*b-g*y)*R,t[4]=(h*T-o*_-l*E)*R,t[5]=(s*_-i*T+n*E)*R,t[6]=(f*x-m*b-v*k)*R,t[7]=(d*b-u*x+g*k)*R,t[8]=(o*C-a*T+l*B)*R,t[9]=(r*T-s*C-n*B)*R,t[10]=(m*M-p*x+v*w)*R,t[11]=(c*x-d*M-g*w)*R,t[12]=(a*E-o*A-h*B)*R,t[13]=(s*A-r*E+i*B)*R,t[14]=(p*k-m*y-f*w)*R,t[15]=(d*y-c*k+u*w)*R)}(this.sToWorld,r)}screenToWorld(t,e){var s=[t/a.canvas.width*2-1,-e/a.canvas.height*2+1,0,1];return function(t,e,s){var r=e[0],i=e[1],n=e[2],o=e[3];t[0]=s[0]*r+s[4]*i+s[8]*n+s[12]*o,t[1]=s[1]*r+s[5]*i+s[9]*n+s[13]*o,t[2]=s[2]*r+s[6]*i+s[10]*n+s[14]*o,t[3]=s[3]*r+s[7]*i+s[11]*n+s[15]*o}(s,s,this.sToWorld),[s[0]/s[3],s[1]/s[3],s[2]/s[3]]}render(){a.canvas.width==window.innerWidth&&a.canvas.height==window.innerHeight||this.resizeCanvas(window.innerWidth,window.innerHeight),a.gl.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT),a.gl.disable(a.gl.BLEND),a.gl.enable(a.gl.CULL_FACE),this.shader.bind(),a.gl.uniformMatrix4fv(this.pUniform,!1,this.pMatrix),a.gl.uniformMatrix4fv(this.vUniform,!1,this.vMatrix),this.altas.bind();var t=this;this.chunkMeshes.forEach((function(e,s,r){var i=e.block_mesh;i&&(a.gl.uniformMatrix4fv(t.mUniform,!1,e.model),i.bind(),i.draw(),i.unbind())})),this.altas.unbind(),this.models.forEach((function(e){e.tex.bind(),e.mesh.bind(),e.instances.forEach((function(s){a.gl.uniformMatrix4fv(t.mUniform,!1,s.matrix),e.mesh.draw()})),e.mesh.unbind(),e.tex.unbind()})),a.gl.disable(a.gl.CULL_FACE),this.altas.bind(),this.chunkMeshes.forEach((function(e,s,r){var i=e.water_mesh;i&&(a.gl.uniformMatrix4fv(t.mUniform,!1,e.model),i.bind(),i.draw(),i.unbind())})),this.altas.unbind(),this.shader.unbind()}}class v{constructor(){this.maps={w:87,s:83,jump:32,shift:16,a:65,d:68,noclip:78,physics:70},this.mx=0,this.my=0,this.ax=this.mx,this.ay=this.my,this.dx=0,this.dy=0,this.mp=!1,this.mrp=!1,this.ms=0,this.mrs=!1,this.state={},this.cx=0,this.cy=0,document.addEventListener("keydown",this.keydown.bind(this)),document.addEventListener("keyup",this.keyup.bind(this)),document.getElementById("glCanvas").addEventListener("mousemove",this.movemouse.bind(this)),document.getElementById("glCanvas").addEventListener("mousedown",this.mousedown.bind(this)),document.getElementById("glCanvas").addEventListener("mouseup",this.mouseup.bind(this))}keypress(t){var e=this.maps[t];if(null==e)return!1;var s=this.state[e];return null==s?(this.state[e]=!1,!1):s}update(){var t=document.getElementById("glCanvas").getBoundingClientRect();this.cx=t.x,this.cy=t.y,this.dx=this.mx-this.ax,this.dy=this.my-this.ay,this.ay=this.my,this.ax=this.mx,this.mp?this.ms=0==this.ms?1:-1:this.ms=0,this.mrp?this.mrs=0==this.mrs?1:-1:this.mrs=0}get mouseX(){return this.mx-this.cx}get mouseY(){return this.my-this.cy}get deltaX(){return this.dx}get deltaY(){return this.dy}get mousePressed(){return this.ms}get mouseRightPressed(){return this.mrs}keydown(t){this.state[t.keyCode]=!0}keyup(t){this.state[t.keyCode]=!1}movemouse(t){this.mx=t.clientX,this.my=t.clientY}mousedown(t){0==t.button&&(this.mp=!0),2==t.button&&(this.mrp=!0)}mouseup(t){0==t.button&&(this.mp=!1),2==t.button&&(this.mrp=!1)}}class w{static setGenInfo(){document.getElementById("main_menu").hidden=!0,document.getElementById("gen_info").hidden=!1,document.getElementById("selector").hidden=!0,document.getElementById("glCanvas").hidden=!0}static genInfoShowText(t){document.getElementById("gen_info").innerText=t}static setPlaying(t){document.getElementById("main_menu").hidden=!0,document.getElementById("gen_info").hidden=!0,document.getElementById("glCanvas").hidden=!1,document.getElementById("selector").hidden=!1;var e=document.getElementById("selector");e.hidden=!1;for(var s=0;s<a.selector.length;s++){var r=document.createElement("div");r.block=a.world.blockMaps.get(a.selector[s]);const i=r.block.sides;r.style.backgroundPosition=16*-i[0]*4+"px "+16*-i[1]*4+"px",r.style.backgroundSize="1024px 1024px",r.style.height="64px",r.style.width="64px",r.onclick=function(){t(this.block.name)},e.appendChild(r)}e.style.padding="4px",e.style.marginLeft=4+Math.floor(16*-a.selector.length*4/2)+"px"}}class k{constructor(t,e,s){this.vao=a.gl.createVertexArray(),this.len=s.length,a.gl.bindVertexArray(this.vao),this.eb=a.gl.createBuffer(),a.gl.bindBuffer(a.gl.ELEMENT_ARRAY_BUFFER,this.eb),a.gl.bufferData(a.gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(s),a.gl.STATIC_DRAW),this.vertex=a.gl.createBuffer(),a.gl.bindBuffer(a.gl.ARRAY_BUFFER,this.vertex),a.gl.bufferData(a.gl.ARRAY_BUFFER,new Float32Array(t),a.gl.STATIC_DRAW),a.gl.vertexAttribPointer(0,3,a.gl.FLOAT,!1,24,0),a.gl.enableVertexAttribArray(0),a.gl.vertexAttribPointer(1,3,a.gl.FLOAT,!0,24,12),a.gl.enableVertexAttribArray(1),this.txt=a.gl.createBuffer(),a.gl.bindBuffer(a.gl.ARRAY_BUFFER,this.txt),a.gl.bufferData(a.gl.ARRAY_BUFFER,new Float32Array(e),a.gl.STATIC_DRAW),a.gl.vertexAttribPointer(2,2,a.gl.FLOAT,!0,0,0),a.gl.enableVertexAttribArray(2),a.gl.bindBuffer(a.gl.ELEMENT_ARRAY_BUFFER,this.eb),a.gl.bindBuffer(a.gl.ARRAY_BUFFER,null),a.gl.bindVertexArray(null)}free(){a.gl.deleteBuffer(this.txt),a.gl.deleteBuffer(this.eb),a.gl.deleteBuffer(this.vertex),a.gl.deleteVertexArray(this.vao),this.vertex=null,this.vao=null,this.eb=null,this.txt=null}bind(){a.gl.bindVertexArray(this.vao)}unbind(){a.gl.bindVertexArray(null)}draw(){a.gl.drawElements(a.gl.TRIANGLES,this.len,a.gl.UNSIGNED_INT,0)}}function x(t,e){const s=a.gl.createShader(t);return a.gl.shaderSource(s,e),a.gl.compileShader(s),a.gl.getShaderParameter(s,a.gl.COMPILE_STATUS)?s:(alert("Cannot create shader: "+a.gl.getShaderInfoLog(s)),a.gl.deleteShader(s),null)}class y{constructor(t,e){if(this.vertex=x(a.gl.VERTEX_SHADER,t),this.fragment=x(a.gl.FRAGMENT_SHADER,e),this.program=a.gl.createProgram(),a.gl.attachShader(this.program,this.vertex),a.gl.attachShader(this.program,this.fragment),a.gl.linkProgram(this.program),!a.gl.getProgramParameter(this.program,a.gl.LINK_STATUS))return alert("Cannot link program "+a.gl.getProgramInfoLog(shaderProgram)),a.gl.deleteProgram(this.program),null}free(){a.gl.deleteShader(this.vertex),a.gl.deleteShader(this.fragment),a.gl.deleteProgram(this.program),this.vertex=null,this.fragment=null,this.program=null}bind(){a.gl.useProgram(this.program)}unbind(){a.gl.useProgram(null)}getUniform(t){return a.gl.getUniformLocation(this.program,t)}}class M{constructor(t){this.texture=a.gl.createTexture(),a.gl.bindTexture(a.gl.TEXTURE_2D,this.texture),a.gl.texImage2D(a.gl.TEXTURE_2D,0,a.gl.RGBA,a.gl.RGBA,a.gl.UNSIGNED_BYTE,t),a.gl.texParameteri(a.gl.TEXTURE_2D,a.gl.TEXTURE_WRAP_S,a.gl.CLAMP_TO_EDGE),a.gl.texParameteri(a.gl.TEXTURE_2D,a.gl.TEXTURE_WRAP_T,a.gl.CLAMP_TO_EDGE),a.gl.texParameteri(a.gl.TEXTURE_2D,a.gl.TEXTURE_MIN_FILTER,a.gl.NEAREST),a.gl.texParameteri(a.gl.TEXTURE_2D,a.gl.TEXTURE_MAG_FILTER,a.gl.NEAREST),a.gl.bindTexture(a.gl.TEXTURE_2D,null)}free(){a.gl.deleteTexture(this.texture),this.texture=null}bind(){a.gl.bindTexture(a.gl.TEXTURE_2D,this.texture)}unbind(){a.gl.bindTexture(a.gl.TEXTURE_2D,null)}}class b{constructor(){this.meshes=new Map,this.shaders=new Map,this.textures=new Map,this.images={}}async loadImages(){const t=t=>{const e=new Image;return e.src=`textures/${t}.png`,new Promise((s=>{e.onload=()=>{s()},this.images[t]=e}))};await t("atlas"),await t("wall")}free(){this.meshes.forEach((function(t){t.free()})),this.shaders.forEach((function(t){t.free()})),this.textures.forEach((function(t){t.free()}))}getTexture(t){var e=this.textures.get(t);return null==e&&(e=new M(this.images[t]),this.textures.set(t,e)),e}createMesh(t,e){var s=this.meshes.get(t);return s&&s.free(),s=new k(e.vertex,e.coords,e.indices),this.meshes.set(t,s),s}createShader(t,e,s){var r=this.meshes.get(t);return r&&r.free(),r=new y(e,s),this.shaders.set(t,r),r}freeMesh(t){this.getMesh(t).free(),this.meshes.delete(t)}freeTexture(t){this.getTexture(t).free(),this.textures.delete(t)}freeShader(t){this.getShader(t).free(),this.shaders.delete(t)}getShader(t){return this.shaders.get(t)}getMesh(t){return this.meshes.get(t)}}var B=function(t,e,s,r){return new(s||(s=Promise))((function(i,n){function o(t){try{h(r.next(t))}catch(t){n(t)}}function a(t){try{h(r.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((r=r.apply(t,e||[])).next())}))},E=function(t,e){var s,r,i,n,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(a){return function(h){return function(a){if(s)throw new TypeError("Generator is already executing.");for(;n&&(n=0,a[0]&&(o=0)),o;)try{if(s=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{s=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,h])}}};function T(){return B(this,void 0,void 0,(function(){var t,e,s;return E(this,(function(r){switch(r.label){case 0:return w.setGenInfo(),a.rm=new b,[4,a.rm.loadImages()];case 1:return r.sent(),t=new f,a.input=new v,e=document.getElementById("world_size"),s=parseInt(e.options[e.selectedIndex].value),a.world=new u(s,8,t),a.world.generateTerrain((function(t){w.genInfoShowText(t+"\nProgres: "+Math.floor(100*a.world.progress)+"%.")}),(function(){w.setPlaying((function(t){a.world.player.buildBlock=t})),a.world.autoLoadChunks();var e=Date.now(),s=0;t.clearColor(.53,.807,.98),requestAnimationFrame((function r(){var i=(Date.now()-e)/1e3;for(e=Date.now(),a.input.update(),a.world.update(i),t.render(),++s>=20&&(s=0);Date.now()-e<1e3/60;);requestAnimationFrame(r)}))})),[2]}}))}))}a.canvas=document.getElementById("glCanvas"),a.gl=a.canvas.getContext("webgl2"),null==a.gl&&alert("Cannot use webgl"),game=e})();